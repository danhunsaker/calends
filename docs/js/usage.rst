.. _usage-js:

.. index::
   pair: usage; JS
   pair: usage; WASM

.. js:module:: calends

Using Calends in JS/WASM
========================

Calends exposes a very small handful of things for use outside the library
itself. One is the :js:class:`Calends` class, documented here, which should be
the only interface users of the library ever need to touch.

Another thing Calends exposes is the :js:class:`TAI64Time` class, used to store
and manipulate the instants of time which make up a :js:class:`Calends`
moment or instance. The rest are interfaces for extending the library's
functionality. These are covered in the
:ref:`Custom Calendars in JS/WASM <custom-calendars-js>` section.

.. note::

   :js:class:`Calends` objects are immutable - all methods return a new
   :js:class:`Calends` object where they might otherwise alter the current one.
   This has the side effect of using more memory to perform manipulations than
   updating values on an existing object would. It makes many operations safer,
   though, than mutable objects would allow.

Create
------

.. js:class:: Calends(stamp, calendar, format)

   :param mixed stamp: The value to parse the date(s)/time(s) from.
   :param string calendar: The calendar system to parse the date(s)/time(s)
                           with.
   :param string format: The format the date(s)/time(s) is/are expected to use.
   :return: A new :js:class:`Calends` object
   :rtype: :js:class:`Calends`
   :throws CalendsException: when an error occurs

   Creates a new :js:class:`Calends` object, using ``calendar`` to select a
   calendar system, and ``format`` to parse the contents of ``stamp`` into the
   :js:class:`Calends` object's internal instants. The type of ``stamp`` can
   vary based on the calendar system itself, but generally speaking can always
   be a string.

   In any case, the value can always be an associative array, where the keys are
   any two of ``start``, ``end``, and ``duration``. If all three are provided,
   ``duration`` is ignored in favor of calculating it directly.

   The calendar system then converts ``stamp`` to a :js:class:`TAI64Time`
   instant, which the :js:class:`Calends` object sets to the appropriate
   internal value.

Read
----

   .. js:method:: Calends.date(calendar, format)

      :param string calendar: The calendar system to format the date/time with.
      :param string format: The format the date/time is expected to be in.
      :return: The start date of the :js:class:`Calends` object
      :rtype: string
      :throws CalendsException: when an error occurs

      Retrieves the start date of the :js:class:`Calends` object as a string.
      The value is generated by the calendar system given in ``calendar``,
      according to the format string in ``format``.

   .. js:method:: Calends.endDate(calendar, format)

      :param string calendar: The calendar system to format the date/time with.
      :param string format: The format the date/time is expected to be in.
      :return: The end date of the :js:class:`Calends` object
      :rtype: string
      :throws CalendsException: when an error occurs

      Retrieves the end date of the :js:class:`Calends` object as a string. The
      value is generated by the calendar system given in ``calendar``,
      according to the format string in ``format``.

   .. js:method:: Calends.duration()

      :return: The duration of the :js:class:`Calends` object
      :rtype: string

      Retrieves the duration of the :js:class:`Calends` object as a decimal
      string. This value will be ``0`` if the :js:class:`Calends` object is an
      instant.

Update
------

   .. js:method:: Calends.withDate(stamp, calendar, format)

      :param mixed stamp: The value to parse the date/time from.
      :param string calendar: The calendar system to parse the date/time with.
      :param string format: The format the date/time is expected to use.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`
      :throws CalendsException: when an error occurs

      Returns a :js:class:`Calends` object with a start date based on the
      current :js:class:`Calends` object's value. The inputs are the same as
      for :js:class:`Calends`, above, except the string → value map option isn't
      available, since you're already specifically setting the start value
      explicitly.

   .. js:method:: Calends.withEndDate(stamp, calendar, format)

      :param mixed stamp: The value to parse the date/time from.
      :param string calendar: The calendar system to parse the date/time with.
      :param string format: The format the date/time is expected to use.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`
      :throws CalendsException: when an error occurs

      Returns a :js:class:`Calends` object with an end date based on the
      current :js:class:`Calends` object's value. The inputs are the same as
      for :js:class:`Calends`, above, except the string → value map option isn't
      available, since you're already specifically setting the end value
      explicitly.

   .. js:method:: Calends.withDuration(duration, calendar)

      :param string duration: The value to parse the new duration from.
      :param string calendar: The calendar system to parse the date/time with.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`
      :throws CalendsException: when an error occurs

      Returns a :js:class:`Calends` object with a duration set by adjusting the
      current :js:class:`Calends` object's end point, and using its start point
      as an anchor. The ``duration`` value is interpreted by the calendar
      system given in ``calendar``, so is subject to any of its rules.

   .. js:method:: Calends.withDurationFromEnd(duration, calendar)

      :param string duration: The value to parse the new duration from.
      :param string calendar: The calendar system to parse the date/time with.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`
      :throws CalendsException: when an error occurs

      Returns a :js:class:`Calends` object with a duration set by adjusting the
      current :js:class:`Calends` object's start point, and using its end point
      as an anchor. The ``duration`` value is interpreted by the calendar
      system given in ``calendar``, so is subject to any of its rules.

Manipulate
----------

   .. js:method:: Calends.add(offset, calendar)

      :param string offset: The value to parse the offset from.
      :param string calendar: The calendar system to parse the date/time with.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`
      :throws CalendsException: when an error occurs

      Increases the end date of the :js:class:`Calends` object's current value
      by ``offset``, as interpreted by the calendar system given in
      ``calendar``, and returns a new :js:class:`Calends` object with the
      result.

   .. js:method:: Calends.addFromEnd(offset, calendar)

      :param string offset: The value to parse the offset from.
      :param string calendar: The calendar system to parse the date/time with.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`
      :throws CalendsException: when an error occurs

      Increases the start date of the :js:class:`Calends` object's current
      value by ``offset``, as interpreted by the calendar system given in
      ``calendar``, and returns a new :js:class:`Calends` object with the
      result.

   .. js:method:: Calends.subtract(offset, calendar)

      :param string offset: The value to parse the offset from.
      :param string calendar: The calendar system to parse the date/time with.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`
      :throws CalendsException: when an error occurs

      Works the same as :js:meth:`add`, except it decreases the start date,
      rather than increasing the end date.

   .. js:method:: Calends.subtractFromEnd(offset, calendar)

      :param string offset: The value to parse the offset from.
      :param string calendar: The calendar system to parse the date/time with.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`
      :throws CalendsException: when an error occurs

      Works the same as :js:meth:`addFromEnd`, except it decreases the end
      date, rather than increasing the start date.

   .. js:method:: Calends.next(offset, calendar)

      :param string offset: The value to parse the offset from.
      :param string calendar: The calendar system to parse the date/time with.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`
      :throws CalendsException: when an error occurs

      Returns a :js:class:`Calends` object of ``offset`` duration (as
      interpreted by the calendar system given in ``calendar``), which abuts
      the current :js:class:`Calends` object's value. If ``offset`` is empty,
      ``calendar`` is ignored, and the current object's duration is used
      instead.

   .. js:method:: Calends.previous(offset, calendar)

      :param string offset: The value to parse the offset from.
      :param string calendar: The calendar system to parse the date/time with.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`
      :throws CalendsException: when an error occurs

      Returns a :js:class:`Calends` object of ``offset`` duration (as
      interpreted by the calendar system given in ``calendar``), which abuts
      the current :js:class:`Calends` object's value. If ``offset`` is empty,
      ``calendar`` is ignored, and the current object's duration is used
      instead.

Combine
-------

   .. js:method:: Calends.merge(other)

      :param Calends other: The :js:class:`Calends` object to merge.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`
      :throws CalendsException: when an error occurs

      Returns a :js:class:`Calends` object spanning from the earliest start date
      to the latest end date between the current :js:class:`Calends` object and
      ``other``.

   .. js:method:: Calends.intersect(other)

      :param Calends other: The :js:class:`Calends` object to intersect.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`
      :throws CalendsException: when an error occurs

      Returns a :js:class:`Calends` object spanning the overlap between the
      current :js:class:`Calends` object and ``other``. If the current object
      and ``other`` don't overlap, throws an error.

   .. js:method:: Calends.gap(other)

      :param Calends other: The :js:class:`Calends` object to gap.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`
      :throws CalendsException: when an error occurs

      Returns a :js:class:`Calends` object spanning the gap between the current
      :js:class:`Calends` object and ``other``. If the current object and
      ``other`` overlap (and there is, therefore, no gap to return), throws an
      error.

Compare
-------

   .. js:method:: Calends.difference(other, mode)

      :param Calends other: The :js:class:`Calends` object to compare.
      :param string mode: The comparison mode.
      :return: The difference, as a decimal string
      :rtype: string

      Returns the difference of the current :js:class:`Calends` object minus
      ``other``, using ``mode`` to select which values to use in the
      calculation. Valid ``mode``\ s include:

      - ``start`` - use the start date of both the current object and ``other``
      - ``duration`` - use the duration of both the current object and ``other``
      - ``end`` - use the end date of both the current object and ``other``
      - ``start-end`` - use the start of the current object, and the end of
        ``other``
      - ``end-start`` - use the end of the current object, and the start of
        ``other``

   .. js:method:: Calends.compare(other, mode)

      :param Calends other: The :js:class:`Calends` object to compare.
      :param string mode: The comparison mode.
      :return: A standard comparison result
      :rtype: int

      Returns ``-1`` if the current :js:class:`Calends` object is less than
      ``other``, ``0`` if they are equal, and ``1`` if the current object is
      greater than ``other``, using ``mode`` to select which values to use in
      the comparison. Valid ``mode``\ s are the same as for
      :js:meth:`Calends.difference`, above.

   .. js:method:: Calends.contains(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Checks whether the current :js:class:`Calends` object contains all of
      ``other``.

   .. js:method:: Calends.overlaps(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Checks whether the current :js:class:`Calends` object overlaps with
      ``other``.

   .. js:method:: Calends.abuts(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Checks whether the current :js:class:`Calends` object abuts ``other``
      (that is, whether one begins at the same instant the other ends).

   .. js:method:: Calends.isSame(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Checks whether the current :js:class:`Calends` object covers the same span
      of time as ``other``.

   .. js:method:: Calends.isShorter(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Compares the duration of the current :js:class:`Calends` object and
      ``other``.

   .. js:method:: Calends.isSameDuration(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Compares the duration of the current :js:class:`Calends` object and
      ``other``.

   .. js:method:: Calends.isLonger(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Compares the duration of the current :js:class:`Calends` object and
      ``other``.

   .. js:method:: Calends.isBefore(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Compares the entirety of the current :js:class:`Calends` object with the
      start date of ``other``.

   .. js:method:: Calends.startsBefore(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Compares the start date of the current :js:class:`Calends` object with
      the start date of ``other``.

   .. js:method:: Calends.endsBefore(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Compares the end date of the current :js:class:`Calends` object with the
      start date of ``other``.

   .. js:method:: Calends.isDuring(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Checks whether the entirety of the current :js:class:`Calends` object lies
      between the start and end dates of ``other``.

   .. js:method:: Calends.startsDuring(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Checks whether the start date of the current :js:class:`Calends` object
      lies between the start and end dates of ``other``.

   .. js:method:: Calends.endsDuring(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Checks whether the end date of the current :js:class:`Calends` object lies
      between the start and end dates of ``other``.

   .. js:method:: Calends.isAfter(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Compares the entirety of the current :js:class:`Calends` object with the
      end date of ``other``.

   .. js:method:: Calends.startsAfter(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Compares the start date of the current :js:class:`Calends` object with the
      end date of ``other``.

   .. js:method:: Calends.endsAfter(other)

      :param Calends other: The :js:class:`Calends` object to compare.
      :return: The result of the comparison
      :rtype: bool

      Compares the end date of the current :js:class:`Calends` object with the
      end date of ``other``.

Export
------

It is possible to export :js:class:`Calends` objects for use later/elsewhere, or
to import such values for use in your own code. There are two formats for this
purpose: text encoding and JSON encoding. Needless to say, the JSON encoding is
considerably more portable, and therefore preferred. Still, both are supported,
and as such both are documented here. YMMV.

   .. js:method:: Calends.toText()

      :return: The text encoding of the :js:class:`Calends` object.
      :rtype: string

   .. js:method:: Calends.fromText(stamp)

      :param stamp: The text encoded value to import.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`

   .. js:method:: Calends.toJson()

      :return: The JSON encoding of the :js:class:`Calends` object.
      :rtype: string

   .. js:method:: Calends.fromJson(stamp)

      :param stamp: The JSON encoded value to import.
      :return: A new :js:class:`Calends` object
      :rtype: :js:class:`Calends`

For logging, there's also a ``toString()`` method; we don't recommend using it
directly since the output is neither human-readable nor machine-importable.

In addition to the above, there's improved JSON support in JS (go figure) with
the following methods:

   .. code-block:: javascript

      JSON.stringify(objectWithMomentChildren);

   .. code-block:: javascript

      JSON.parse(stored, Calends.reviver);

Error Handling
--------------

.. js:class:: CalendsError

   A very simple error class, directly extending :js:class:`Error`. It is thrown
   by the library for all encountered errors.
